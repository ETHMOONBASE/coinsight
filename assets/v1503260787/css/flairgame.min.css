var BULL_STR="<span class='flair-position-bull'>Bullish</span>";var BULL_STRl="<span class='flair-position-bull'>bullish</span>";var BEAR_STR="<span class='flair-position-bear'>Bearish</span>";var BEAR_STRl="<span class='flair-position-bear'>bearish</span>";var UNSET_STR="<span class='flair-position-unset'>Unset</span>";var UNSET_STRl="<span class='flair-position-unset'>unset</span>";var INACTIVE_STR="<span class='flair-position-inactive'>Inactive</span>";var INACTIVE_STRl="<span class='flair-position-inactive'>inactive</span>";var ACTIVE_STRl="<span class='flair-position-inactive'>active</span>";var BITSTAMP_ICON='<img src="/images/bitstamp-small.png" alt="[Bitstamp]" style="padding-left:1px; padding-right:2px; margin-bottom:-2px;" />';var MTGOX_ICON='<img src="/images/mtgox-small.png" alt="[Mt.Gox]" style="padding-left:1px; padding-right:2px; margin-bottom:-2px;" />';var reddit_data=null;var charting_loaded=false;var API_EVERYTHING_URL="/api/flairgame/webpage";var REDDIT_USER_BALANCE_DEFAULT=null;$(function(){$("#flairgame-play").button();$("#flair-game-help").button({icons:{primary:"ui-icon-help"}});$("#flair-game-help").click(function(){$("#flair-game-explanation").toggle()});$("#flair-users-table").dataTable({fnDrawCallback:function(c){if(c.bSorted||c.bFiltered){for(var b=0,a=c.aiDisplay.length;b<a;b++){$("td:eq(0)",c.aoData[c.aiDisplay[b]].nTr).html(b+1)}}},bJQueryUI:true,bAutoWidth:false,aaSorting:[[5,"desc"]],aoColumns:[{mData:"num",sDefaultContent:"",bSortable:false},{mData:"username",sDefaultContent:"anonymous"},{mData:"flair_str",sDefaultContent:"TBD"},{mData:"last_change",sDefaultContent:"TBD"},{mData:"balance",sDefaultContent:"TBD"},{mData:"total_profit",sDefaultContent:"TBD"},{mData:"trading_frequency",sDefaultContent:"TBD"}]});REDDIT_USER_BALANCE_DEFAULT=$("#reddit-user-balance").html();prepare_reddit_user_balance();$.ajax({url:API_EVERYTHING_URL,context:document.body}).done(function(a){reddit_flairs_update(a.reddit.flairs);reddit_stats_update(a.reddit.stats,a.reddit.flairs.prices);reddit_data=a.reddit;if(charting_loaded){drawCharts()}set_reddit_user_balance()})});function prepare_reddit_user_balance(){$("#reddit-user-balance-form").submit(function(b){var a=$("input[name='reddit_flair_user']").val();set_reddit_user_balance();$.ajax({url:"/api/flairgame/user/"+a,context:document.body}).done(function(c){if(reddit_data){reddit_data.user=c;set_reddit_user_balance()}});b.preventDefault()});set_reddit_user_balance()}function flairgame_buy(){var a="/api/flairgame/buy";return flairgame_request(a)}function flairgame_switchexchange(a){var b="/api/flairgame/switchexchange?exchange="+a;return flairgame_request(b)}function flairgame_sell(){var a="/api/flairgame/sell";return flairgame_request(a)}function view_reddit_user_balance(){if(!reddit_data||!reddit_data.user){return}if(!reddit_data.user.user){unset_reddit_flair_user();return}var b=reddit_data.user;var f=reddit_data.user.trades[0].new_balance_str;var g="flair flair-bullish";var h="Bullish";var e='<a href="#" onclick="return flairgame_sell();">Switch to Bearish</a>';if(b.user.inactive){g="flair flair-inactive";h="Inactive";e='Switch to <a href="#" onclick="return flairgame_buy();">Bullish</a>/<a href="#" onclick="return flairgame_sell();">Bearish</a>'}else{if(b.user.flair=="unset"){g="flair flair-unset";h="Unset";e='Switch to <a href="#" onclick="return flairgame_buy();">Bullish</a>/<a href="#" onclick="return flairgame_sell();">Bearish</a>'}else{if(b.user.flair=="bear"){g="flair flair-bearish";h="Bearish";e='<a href="#" onclick="return flairgame_buy();">Switch to Bullish</a>'}}}var c='<a href="#" onclick="return flairgame_switchexchange(1);">Switch to Bitstamp</a>';if(b.user.exchange==1){c="Stay tuned."}var d=MTGOX_ICON;if(b.user.exchange==1){d=BITSTAMP_ICON}var i=$("#flair-userbox-template").html();var a=Mustache.render(i,{username_url:b.user.username,username:b.user.username,user_css_classes:g,exchange_image:d,position_text:h,new_balance_str:f,switch_text:e,btc_address:b.user.btc_address,deposit_address:b.user.deposit_address,deposit_balance:b.user.deposit_balance,orders_table_html:$("#reddit-user-orders-init").html(),trades_table_html:$("#reddit-user-box-init").html(),exchange_text:c});$("#reddit-user-balance").html(a);$("#trader-tabs").tabs();$("#reddit-user-balance").removeClass("reddit-user-balance-default");$("#reddit-user-balance").addClass("reddit-user-balance-occupied");b=reddit_user_parse(b);console.log(b.trades);$("#reddit-user-balance-box > #reddit-user-table").dataTable({fnDrawCallback:function(l){if(l.bSorted||l.bFiltered){for(var k=0,j=l.aiDisplay.length;k<j;k++){$("td:eq(0)",l.aoData[l.aiDisplay[k]].nTr).html(k+1)}}},bJQueryUI:true,bAutoWidth:false,aaSorting:[[1,"desc"]],aoColumns:[{mData:"num",sDefaultContent:"",bSortable:false},{mData:"time",sDefaultContent:"unknown"},{mData:"flair_str",sDefaultContent:"TBD"},{mData:"new_balance_str",sDefaultContent:"TBD"},{mData:"price_str",sDefaultContent:"TBD"}],iDisplayLength:5,bLengthChange:false}).fnAddData(b.trades);$("#reddit-user-balance-box > .dataTables_wrapper").css("width","100%");$("#reddit-user-balance-box > .dataTables_wrapper > div:first").css("display","none");$("#reddit-user-balance-box > .dataTables_wrapper > div:last").css("background",'url("images/ui-bg_glass_85_dfeffc_1x400.png") repeat-x scroll 50% 50% rgb(223, 239, 252)');$("#reddit-user-balance-box > .dataTables_wrapper > div:last").css("border","1px solid rgb(197, 219, 236)");$("#reddit-user-balance-box > .dataTables_wrapper > div:last").css("color","rgb(46, 110, 158)");$("#reddit-user-orders-box > #flair-orders-table").dataTable({fnDrawCallback:function(l){if(l.bSorted||l.bFiltered){for(var k=0,j=l.aiDisplay.length;k<j;k++){$("td:eq(0)",l.aoData[l.aiDisplay[k]].nTr).html(k+1)}}},bJQueryUI:true,bAutoWidth:false,aaSorting:[[1,"desc"]],aoColumns:[{mData:"num",sDefaultContent:"",bSortable:false},{mData:"open_time",sDefaultContent:"unknown"},{mData:"position_str",sDefaultContent:"TBD"},{mData:"price_limit",sDefaultContent:"TBD"},{mData:"actions_str",sDefaultContent:"TBD"}],iDisplayLength:5,bLengthChange:false}).fnAddData(b.orders);$("#reddit-user-orders-box > .dataTables_wrapper").css("width","100%");$("#reddit-user-orders-box > .dataTables_wrapper > div:first").css("display","none");$("#reddit-user-orders-box > .dataTables_wrapper > div:last").css("background",'url("images/ui-bg_glass_85_dfeffc_1x400.png") repeat-x scroll 50% 50% rgb(223, 239, 252)');$("#reddit-user-orders-box > .dataTables_wrapper > div:last").css("border","1px solid rgb(197, 219, 236)");$("#reddit-user-orders-box > .dataTables_wrapper > div:last").css("color","rgb(46, 110, 158)");$("#trade-limit-upper-button").button();$("#trade-limit-upper-button").click(function(k){var m=$("#trade-limit-upper").val();var l=0;var j=$("#trade-position").val();flairgame_limit_create(j,l,m);k.preventDefault();return false});$("#trade-limit-lower-button").button();$("#trade-limit-lower-button").click(function(k){var m=$("#trade-limit-lower").val();var l=1;var j=$("#trade-position").val();console.log(j);flairgame_limit_create(j,l,m);k.preventDefault();return false});$("#trader-save-settings").button();$("#trader-save-settings").click(function(k){var l=$("#trader-btc-address").val();var j={btc_address:l};flairgame_save_settings(j);k.preventDefault();return false})}function flairgame_save_settings(a){var c=encodeURIComponent(a.btc_address);var b="/api/flairgame/settings?btc_address="+c;return flairgame_request(b)}function flairgame_limit_create(a,c,d){a=encodeURIComponent(a);c=encodeURIComponent(c);d=encodeURIComponent(d);reddit_data.user=null;set_reddit_user_balance();var b="/api/flairgame/limit/create?position="+a+"&price_limit="+d+"&limit_type="+c;return flairgame_request(b)}function flairgame_limit_cancel(b){b=encodeURIComponent(b);var a="/api/flairgame/limit/cancel?order_id="+b;return flairgame_request(a)}function flairgame_request(a){reddit_data.user=null;set_reddit_user_balance();$.ajax({url:a,context:document.body}).done(function(b){if(reddit_data){reddit_data.user=b;set_reddit_user_balance()}});set_reddit_user_balance();return false}function set_reddit_user_balance(){if($.cookie("session")){$("#reddit-user-balance").html("Loading...");view_reddit_user_balance()}}function unset_reddit_flair_user(){$.removeCookie("session",{path:"/"});if(reddit_data&&reddit_data.user){reddit_data.user=null}$("#reddit-user-balance").html(REDDIT_USER_BALANCE_DEFAULT);$("#reddit-user-balance").removeClass("reddit-user-balance-occupied");$("#reddit-user-balance").addClass("reddit-user-balance-default");prepare_reddit_user_balance()}google.load("visualization","1.0",{packages:["corechart"]});google.setOnLoadCallback(chartingLoaded);function chartingLoaded(){charting_loaded=true;drawCharts()}$(window).resize(function(){if(this.resizeTO){clearTimeout(this.resizeTO)}this.resizeTO=setTimeout(function(){drawCharts()},500)});function drawCharts(){if(!reddit_data){return}var c=new google.visualization.DataTable();c.addColumn("string","Position");c.addColumn("number","Users");c.addRows([["Bulls",reddit_data.stats.bulls],["Bears",reddit_data.stats.bears],]);var a={title:"/r/BitcoinMarkets flairs",width:$(window).width()*0.2,height:190};var b=new google.visualization.PieChart(document.getElementById("chart_div"));b.draw(c,a)}function reddit_stats_update(b,a){$("#reddit-flairs-last-updated").html(b.time_str);$("#mtgox-price").html(a[0]);$("#bitstamp-price").html(a[1])}function reddit_user_parse(a){_.each(a.trades,function(b){if(b.replace){if(b.exchange==0){b.flair_str='<span style="color:gray;">Switched to Mt.Gox</span>'}else{b.flair_str='<span style="color:gray;">Switched to Bitstamp</span>'}}else{if(b.became_inactive){b.flair_str='<span style="color:gray;">Marked inactive</span>'}else{if(b.new_flair==="bear"){b.flair_str=BEAR_STR}else{if(b.new_flair==="bull"){b.flair_str=BULL_STR}else{b.flair_str='<span style="color:gray;">Unset</span>'}}}}});$("#trader-tabs-orders-link").html("Orders ("+a.orders.length+")");_.each(a.orders,function(b){if(b.new_flair=="bull"){b.position_str=BULL_STR}else{if(b.new_flair=="bear"){b.position_str=BEAR_STR}else{b.position_str='<span style="color:gray;">Unset</span>'}}if(b.limit_type===0){b.price_limit=">= $"+price_limit}else{b.price_limit="<= $"+price_limit}b.actions_str='<a href="#" onclick="return flairgame_limit_cancel('+b.id+');">Cancel</a>'});return a}var reddit_userbox_count=0;function reddit_user_view(a){$.ajax({url:"/api/flairgame/user/"+a,context:document.body}).done(function(c){jQuery("<div/>",{id:"reddit-userbox-"+reddit_userbox_count,title:"User - "+a,}).appendTo("#reddit-user-box");var b=$("#reddit-userbox-"+reddit_userbox_count);b.html($("#reddit-user-box-init").html());c=reddit_user_parse(c);$("#reddit-userbox-"+reddit_userbox_count+" > #reddit-user-table").dataTable({fnDrawCallback:function(f){if(f.bSorted||f.bFiltered){for(var e=0,d=f.aiDisplay.length;e<d;e++){$("td:eq(0)",f.aoData[f.aiDisplay[e]].nTr).html(e+1)}}},bJQueryUI:true,bAutoWidth:false,aaSorting:[[1,"desc"]],aoColumns:[{mData:"num",sDefaultContent:"",bSortable:false},{mData:"time",sDefaultContent:"unknown"},{mData:"flair_str",sDefaultContent:"TBD"},{mData:"new_balance_str",sDefaultContent:"TBD"},{mData:"price_str",sDefaultContent:"TBD"}]}).fnAddData(c.trades);$("#reddit-userbox-"+reddit_userbox_count+" > .dataTables_wrapper").css("width","100%");b.dialog({width:"auto"});reddit_userbox_count++})}function reddit_flairs_update(a){$("#reddit-flair-changes").html("");var b=0;var c=0;_.each(a.changes,function(i){i.price_str="$"+i.price.toFixed(2)+"/BTC";var h;if(i.position=="bear"){h=BEAR_STRl;if(i.replace||i.old_position=="bear"){i.old_balance_str=i.old_balance.toFixed(2)+" USD"}else{i.old_balance_str=i.old_balance.toFixed(4)+" BTC"}i.new_balance_str=i.new_balance.toFixed(2)+" USD";b++}else{if(i.position=="bull"){h=BULL_STRl;if(i.replace||i.old_position=="bull"){i.old_balance_str=i.old_balance.toFixed(4)+" BTC"}else{i.old_balance_str=i.old_balance.toFixed(2)+" USD"}i.new_balance_str=i.new_balance.toFixed(4)+" BTC";c++}}if(i.first||i.old_balance==0){i.old_balance_str="No flair"}var g=" on Mt.Gox";switch(i.exchange){case 0:g=" on Mt.Gox";break;case 1:g="";break}var f="";var e="is now ";if(i.new_flair=="unset"){h=UNSET_STRl;if(i.first){h="";e="has joined the game"}}else{if(i.became_inactive){h=INACTIVE_STRl}else{if(i.was_inactive&&i.old_flair===i.new_flair){h=ACTIVE_STRl}else{f='<span class="flair-change-details">             ('+i.old_balance_str+" &rarr; "+i.new_balance_str+" @ "+i.price_str+")           </span>"}}}$("#reddit-flair-changes").append('      <span title="('+i.old_balance_str+" &rarr; "+i.new_balance_str+" @ $"+i.price+'/BTC)">         <span class="timestamp">['+i.time+']</span>         <a style="color: rgb(46, 110, 158) !important; font-weight:bold;" href="http://reddit.com/user/'+i.username+'">'+i.username+"</a>         "+e+h+g+".         "+f+'      </span><div style="clear:both;"></div>     ')});if(b>c){$("#logo").attr("src","/images/coinsight-bearish-web-logo.png")}else{if(c>b){$("#logo").attr("src","/images/coinsight-bullish-web-logo.png")}}var d=Math.round(new Date().getTime()/1000);_.each(a.users,function(e){e.username="       <a href='http://reddit.com/user/"+e.username+"'>"+e.username+"</a>       <a class='reddit-user-view' style='color: #789 !important;' href='#' onclick='reddit_user_view(\""+e.username+"\"); return false;'>Records</a>     ";e.total_profit=e.total_profit.toFixed(2);e.trading_frequency=e.trading_frequency.toFixed(2);if(e.inactive){e.flair_str=INACTIVE_STR}else{if(e.flair==="bull"){e.flair_str=BULL_STR}else{if(e.flair==="bear"){e.flair_str=BEAR_STR}else{e.flair_str=UNSET_STR}}}if(e.exchange==0){e.flair_str=MTGOX_ICON+" "+e.flair_str}else{if(e.exchange==1){e.flair_str=BITSTAMP_ICON+" "+e.flair_str}}});$("#flair-users-table").dataTable().fnAddData(a.users)}function show_subreddit_stats_charts(){$("#show-subreddit-stats-charts").html("");$.get("/reddit_charts.php",function(a){$("#content").append(a)})};
